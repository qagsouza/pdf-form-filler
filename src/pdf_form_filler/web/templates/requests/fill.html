{% extends "base.html" %}

{% block title %}Preencher: {{ template.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>{{ template.name }}</h2>
                <a href="/templates/{{ template.id }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- PDF Viewer -->
        <div class="col-lg-7 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-file-pdf"></i> Visualiza√ß√£o do PDF</h5>
                </div>
                <div class="card-body p-0">
                    <div id="pdf-container" style="height: 800px; overflow-y: auto; background-color: #525659; position: relative;">
                        <div style="position: relative; display: inline-block;">
                            <canvas id="pdf-canvas" style="display: block;"></canvas>
                            <canvas id="highlight-canvas" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                        </div>
                    </div>
                    <div class="p-3 border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button id="prev-page" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-chevron-left"></i> Anterior
                                </button>
                                <span class="mx-3">
                                    P√°gina <span id="page-num"></span> de <span id="page-count"></span>
                                </span>
                                <button id="next-page" class="btn btn-sm btn-outline-primary">
                                    Pr√≥xima <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                            <div>
                                <button id="zoom-out" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-zoom-out"></i>
                                </button>
                                <span class="mx-2"><span id="zoom-level">100</span>%</span>
                                <button id="zoom-in" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-zoom-in"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Fields -->
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm sticky-top" style="top: 20px; display: flex; flex-direction: column; max-height: 90vh;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil-square"></i> Preencher Campos
                    </h5>
                </div>

                <!-- Batch Controls -->
                <div class="card-body border-bottom bg-light py-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="badge bg-primary" id="instance-counter">Inst√¢ncia 1 de 1</span>
                            <span class="badge bg-info ms-1" id="total-instances">Total: 1</span>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary" id="btn-prev-instance" disabled>
                                <i class="bi bi-chevron-left"></i> Anterior
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="btn-next-instance">
                                Pr√≥xima <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-success" id="btn-add-instance">
                            <i class="bi bi-plus-circle"></i> Nova Inst√¢ncia
                        </button>
                        <button type="button" class="btn btn-sm btn-warning" id="btn-duplicate-instance">
                            <i class="bi bi-files"></i> Duplicar
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" id="btn-delete-instance">
                            <i class="bi bi-trash"></i> Excluir
                        </button>
                        <div class="ms-auto">
                            <a href="/templates/{{ template.id }}/download-excel" class="btn btn-sm btn-info">
                                <i class="bi bi-download"></i> Excel
                            </a>
                            <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#uploadExcelModal">
                                <i class="bi bi-upload"></i> Importar
                            </button>
                        </div>
                    </div>
                </div>

                <form id="fill-form" method="POST" action="/fill/{{ template.id }}" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
                    <input type="hidden" name="batch_data" id="batch-data-input">

                    {% if fields %}
                    <div class="card-body" style="overflow-y: auto; flex: 1;">
                        <p class="text-muted mb-3">
                            <i class="bi bi-info-circle"></i> Selecione um campo para ver sua localiza√ß√£o destacada no PDF.
                        </p>

                        {% for field_name, field_info in fields.items() %}
                        <div class="mb-3 field-group"
                             data-page="{{ field_info.page + 1 }}"
                             data-rect="{{ field_info.rect | tojson if field_info.rect else '[]' }}">
                            <label for="field_{{ loop.index }}" class="form-label">
                                <strong>{{ field_info.label if field_info.label else field_name }}</strong>
                                {% if field_info.label %}
                                <span class="badge bg-info ms-1" style="font-size: 0.65em;" title="Nome do campo">{{ field_name }}</span>
                                {% endif %}
                                <span class="badge bg-secondary ms-2" style="font-size: 0.7em; cursor: pointer;"
                                      onclick="goToPage({{ field_info.page + 1 }})"
                                      title="Clique para ir para a p√°gina no PDF">
                                    üìÑ P√°g. {{ field_info.page + 1 }}
                                </span>
                            </label>
                            {% if field_info.label %}
                            <div class="form-text text-muted small">{{ field_name }}</div>
                            {% endif %}

                            {% set is_locked = field_config.get(field_name, {}).get('locked', False) %}
                            {% set field_value = merged_defaults.get(field_name, '') %}
                            {% set is_dynamic = field_config.get(field_name, {}).get('dynamic_type') %}

                            {% if field_info.type == 'button' %}
                                <!-- Checkbox -->
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           id="field_{{ loop.index }}"
                                           name="{{ field_name }}"
                                           value="on"
                                           {% if field_value %}checked{% endif %}
                                           {% if is_locked %}disabled{% endif %}>
                                    <label class="form-check-label" for="field_{{ loop.index }}">
                                        Marcar
                                        {% if is_locked %}
                                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.7em;">üîí Travado</span>
                                        {% endif %}
                                    </label>
                                    {% if is_locked %}
                                    <input type="hidden" name="{{ field_name }}" value="{% if field_value %}on{% endif %}">
                                    {% endif %}
                                </div>
                            {% elif field_info.type == 'choice' and field_info.options %}
                                <!-- Select/Radio -->
                                <select class="form-select" id="field_{{ loop.index }}" name="{{ field_name }}"
                                        {% if is_locked %}disabled{% endif %}>
                                    <option value="">-- Selecione --</option>
                                    {% for option in field_info.options %}
                                    <option value="{{ option }}"
                                            {% if field_value == option %}selected{% endif %}>
                                        {{ option }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if is_locked %}
                                <input type="hidden" name="{{ field_name }}" value="{{ field_value }}">
                                <small class="text-muted">üîí Campo travado{% if is_dynamic %} (valor din√¢mico){% endif %}</small>
                                {% endif %}
                            {% else %}
                                <!-- Text/Number/Date/Email/Tel/URL input -->
                                {% set field_type = field_config.get(field_name, {}).get('field_type', 'text') if field_config else 'text' %}
                                {% if field_type == 'date' %}
                                    <input type="date" class="form-control"
                                           id="field_{{ loop.index }}"
                                           name="{{ field_name }}"
                                           value="{{ field_value }}"
                                           {% if is_locked %}readonly{% endif %}
                                           {% if is_locked %}style="background-color: #f8f9fa;"{% endif %}>
                                    <small class="form-text text-muted">üìÖ Selecione uma data</small>
                                {% elif field_type == 'number' %}
                                    <input type="number" class="form-control"
                                           id="field_{{ loop.index }}"
                                           name="{{ field_name }}"
                                           value="{{ field_value }}"
                                           placeholder="Digite um n√∫mero"
                                           step="any"
                                           {% if is_locked %}readonly{% endif %}
                                           {% if is_locked %}style="background-color: #f8f9fa;"{% endif %}>
                                    <small class="form-text text-muted">üî¢ Apenas n√∫meros</small>
                                {% elif field_type == 'email' %}
                                    <input type="email" class="form-control"
                                           id="field_{{ loop.index }}"
                                           name="{{ field_name }}"
                                           value="{{ field_value }}"
                                           placeholder="email@exemplo.com"
                                           {% if is_locked %}readonly{% endif %}
                                           {% if is_locked %}style="background-color: #f8f9fa;"{% endif %}>
                                    <small class="form-text text-muted">‚úâÔ∏è Formato de email</small>
                                {% elif field_type == 'tel' %}
                                    <input type="tel" class="form-control"
                                           id="field_{{ loop.index }}"
                                           name="{{ field_name }}"
                                           value="{{ field_value }}"
                                           placeholder="(00) 00000-0000"
                                           {% if is_locked %}readonly{% endif %}
                                           {% if is_locked %}style="background-color: #f8f9fa;"{% endif %}>
                                    <small class="form-text text-muted">üìû N√∫mero de telefone</small>
                                {% elif field_type == 'url' %}
                                    <input type="url" class="form-control"
                                           id="field_{{ loop.index }}"
                                           name="{{ field_name }}"
                                           value="{{ field_value }}"
                                           placeholder="https://exemplo.com"
                                           {% if is_locked %}readonly{% endif %}
                                           {% if is_locked %}style="background-color: #f8f9fa;"{% endif %}>
                                    <small class="form-text text-muted">üîó URL completa</small>
                                {% else %}
                                    <input type="text" class="form-control"
                                           id="field_{{ loop.index }}"
                                           name="{{ field_name }}"
                                           value="{{ field_value }}"
                                           placeholder="Digite o valor"
                                           {% if is_locked %}readonly{% endif %}
                                           {% if is_locked %}style="background-color: #f8f9fa;"{% endif %}>
                                {% endif %}
                                {% if is_locked %}
                                <small class="text-muted">üîí Campo travado{% if is_dynamic %} (valor din√¢mico){% endif %}</small>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    <div class="card-footer bg-white border-top" style="flex-shrink: 0;">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-file-earmark-pdf"></i> Gerar PDF Preenchido
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="card-body">
                        <div class="alert alert-warning">
                            Este PDF n√£o possui campos preench√≠veis detectados.
                        </div>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Upload Excel Modal -->
<div class="modal fade" id="uploadExcelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-upload"></i> Importar Dados do Excel
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">
                    Fa√ßa upload de um arquivo Excel (.xlsx) com os dados preenchidos.
                    O arquivo deve ter o formato gerado pelo bot√£o "Download Excel".
                </p>
                <input type="file" class="form-control" id="excel-file-input" accept=".xlsx">
                <div id="excel-upload-status" class="mt-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-process-excel">
                    <i class="bi bi-check-circle"></i> Importar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
    .sticky-top {
        position: sticky;
        z-index: 1020;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    // PDF.js setup
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.5;
    let currentPage = null;
    let currentHighlight = null; // Store current highlight state

    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const highlightCanvas = document.getElementById('highlight-canvas');
    const highlightCtx = highlightCanvas.getContext('2d');

    // Load PDF (with version parameter to prevent caching after PDF replacement)
    const url = '/templates/{{ template.id }}/download?v={{ template.version }}';

    console.log('Loading PDF from:', url);

    // Load PDF with proper configuration
    const loadingTask = pdfjsLib.getDocument({
        url: url,
        withCredentials: true,
        isEvalSupported: false
    });

    loadingTask.promise.then(function(pdfDoc_) {
        pdfDoc = pdfDoc_;
        document.getElementById('page-count').textContent = pdfDoc.numPages;
        renderPage(pageNum);
        console.log('PDF loaded successfully, pages:', pdfDoc.numPages);
    }).catch(function(error) {
        console.error('Error loading PDF:', error);
        // Try to fetch the URL directly to see the actual error
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.blob();
            })
            .then(blob => {
                console.log('Fetch succeeded, blob size:', blob.size, 'type:', blob.type);
                // If fetch works but PDF.js fails, show different error
                document.getElementById('pdf-container').innerHTML =
                    '<div class="alert alert-warning m-3">PDF encontrado mas n√£o pode ser renderizado. Blob size: ' +
                    blob.size + ', Type: ' + blob.type + '</div>';
            })
            .catch(fetchError => {
                console.error('Fetch error:', fetchError);
                document.getElementById('pdf-container').innerHTML =
                    '<div class="alert alert-danger m-3">Erro ao carregar PDF: ' + fetchError.message +
                    '<br>URL: ' + url + '</div>';
            });
    });

    function renderPage(num) {
        pageRendering = true;

        pdfDoc.getPage(num).then(function(page) {
            currentPage = page;
            const viewport = page.getViewport({scale: scale});
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            highlightCanvas.height = viewport.height;
            highlightCanvas.width = viewport.width;

            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };

            const renderTask = page.render(renderContext);

            renderTask.promise.then(function() {
                pageRendering = false;
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }

                // Re-apply highlight if exists and matches current page
                if (currentHighlight && currentHighlight.page === num) {
                    highlightField(currentHighlight.rect, currentHighlight.page);
                }
            });
        });

        document.getElementById('page-num').textContent = num;
    }

    function highlightField(rect, page) {
        // Clear previous highlight
        highlightCtx.clearRect(0, 0, highlightCanvas.width, highlightCanvas.height);

        if (!rect || rect.length !== 4 || !currentPage || page !== pageNum) {
            return;
        }

        // Store current highlight state
        currentHighlight = { rect: rect, page: page };

        const viewport = currentPage.getViewport({scale: scale});

        // PDF coordinates: [x1, y1, x2, y2] where y is from bottom
        // Canvas coordinates: y is from top
        const x = rect[0] * scale;
        const y = viewport.height - (rect[3] * scale);
        const width = (rect[2] - rect[0]) * scale;
        const height = (rect[3] - rect[1]) * scale;

        // Draw highlight rectangle
        highlightCtx.fillStyle = 'rgba(255, 235, 59, 0.4)'; // Yellow with transparency
        highlightCtx.fillRect(x, y, width, height);

        // Draw border
        highlightCtx.strokeStyle = 'rgba(255, 193, 7, 0.8)'; // Darker yellow
        highlightCtx.lineWidth = 2;
        highlightCtx.strokeRect(x, y, width, height);
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    function onPrevPage() {
        if (pageNum <= 1) {
            return;
        }
        pageNum--;
        queueRenderPage(pageNum);
    }

    function onNextPage() {
        if (pageNum >= pdfDoc.numPages) {
            return;
        }
        pageNum++;
        queueRenderPage(pageNum);
    }

    function zoomIn() {
        scale += 0.25;
        document.getElementById('zoom-level').textContent = Math.round(scale * 100);
        queueRenderPage(pageNum);
    }

    function zoomOut() {
        if (scale <= 0.5) return;
        scale -= 0.25;
        document.getElementById('zoom-level').textContent = Math.round(scale * 100);
        queueRenderPage(pageNum);
    }

    document.getElementById('prev-page').addEventListener('click', onPrevPage);
    document.getElementById('next-page').addEventListener('click', onNextPage);
    document.getElementById('zoom-in').addEventListener('click', zoomIn);
    document.getElementById('zoom-out').addEventListener('click', zoomOut);

    // Function to navigate to specific page
    window.goToPage = function(page) {
        if (page >= 1 && page <= (pdfDoc ? pdfDoc.numPages : 1)) {
            pageNum = page;
            queueRenderPage(pageNum);
            // Scroll PDF container to top
            document.getElementById('pdf-container').scrollTop = 0;
        }
    };

    // Highlight field in PDF and form when focusing on input
    document.querySelectorAll('.field-group input, .field-group select, .field-group textarea').forEach(function(input) {
        input.addEventListener('focus', function() {
            const fieldGroup = this.closest('.field-group');
            const page = parseInt(fieldGroup.getAttribute('data-page'));
            const rectStr = fieldGroup.getAttribute('data-rect');

            // Highlight the field group in the form
            fieldGroup.style.backgroundColor = '#fff3cd';
            fieldGroup.style.border = '2px solid #ffc107';
            fieldGroup.style.borderRadius = '5px';
            fieldGroup.style.padding = '10px';

            // Auto-navigate to the page
            if (page && pdfDoc) {
                goToPage(page);

                // Wait for page to render, then highlight
                setTimeout(function() {
                    try {
                        const rect = JSON.parse(rectStr);
                        highlightField(rect, page);
                    } catch (e) {
                        console.log('Could not parse rect:', rectStr);
                    }
                }, 200);
            }
        });

        input.addEventListener('blur', function() {
            const fieldGroup = this.closest('.field-group');
            fieldGroup.style.backgroundColor = '';
            fieldGroup.style.border = '';
            fieldGroup.style.padding = '';

            // Clear highlight on PDF and state
            currentHighlight = null;
            highlightCtx.clearRect(0, 0, highlightCanvas.width, highlightCanvas.height);
        });
    });

    // ========================================
    // Batch Instance Management
    // ========================================

    let instances = [{}]; // Array of instances, each containing field values
    let currentInstanceIndex = 0;

    // Initialize first instance with default values
    function initializeInstances() {
        const firstInstance = {};
        document.querySelectorAll('.field-group input, .field-group select, .field-group textarea').forEach(input => {
            if (input.type === 'checkbox') {
                firstInstance[input.name] = input.checked;
            } else {
                firstInstance[input.name] = input.value;
            }
        });
        instances[0] = firstInstance;
        updateInstanceDisplay();
    }

    // Save current form state to current instance
    function saveCurrentInstance() {
        const instanceData = {};
        document.querySelectorAll('.field-group input, .field-group select, .field-group textarea').forEach(input => {
            if (input.type === 'checkbox') {
                instanceData[input.name] = input.checked;
            } else if (input.type === 'hidden') {
                // Skip hidden fields (they're for locked fields)
                return;
            } else {
                instanceData[input.name] = input.value;
            }
        });
        instances[currentInstanceIndex] = instanceData;
    }

    // Load instance data into form
    function loadInstance(index) {
        if (index < 0 || index >= instances.length) return;

        currentInstanceIndex = index;
        const instanceData = instances[index];

        document.querySelectorAll('.field-group input, .field-group select, .field-group textarea').forEach(input => {
            if (input.type === 'hidden') {
                // Skip hidden fields (they're for locked fields)
                return;
            }

            const value = instanceData[input.name];
            if (input.type === 'checkbox') {
                input.checked = value || false;
            } else {
                input.value = value || '';
            }
        });

        updateInstanceDisplay();
    }

    // Update UI to reflect current instance
    function updateInstanceDisplay() {
        document.getElementById('instance-counter').textContent =
            `Inst√¢ncia ${currentInstanceIndex + 1} de ${instances.length}`;
        document.getElementById('total-instances').textContent =
            `Total: ${instances.length}`;

        // Update button states
        document.getElementById('btn-prev-instance').disabled = currentInstanceIndex === 0;
        document.getElementById('btn-next-instance').disabled = currentInstanceIndex === instances.length - 1;
        document.getElementById('btn-delete-instance').disabled = instances.length === 1;
    }

    // Navigation handlers
    document.getElementById('btn-prev-instance').addEventListener('click', function() {
        saveCurrentInstance();
        loadInstance(currentInstanceIndex - 1);
    });

    document.getElementById('btn-next-instance').addEventListener('click', function() {
        saveCurrentInstance();
        loadInstance(currentInstanceIndex + 1);
    });

    // Add new instance
    document.getElementById('btn-add-instance').addEventListener('click', function() {
        saveCurrentInstance();
        instances.push({});
        loadInstance(instances.length - 1);
    });

    // Duplicate current instance
    document.getElementById('btn-duplicate-instance').addEventListener('click', function() {
        saveCurrentInstance();
        const duplicate = { ...instances[currentInstanceIndex] };
        instances.push(duplicate);
        loadInstance(instances.length - 1);
    });

    // Delete current instance
    document.getElementById('btn-delete-instance').addEventListener('click', function() {
        if (instances.length === 1) return;

        if (confirm('Tem certeza que deseja excluir esta inst√¢ncia?')) {
            instances.splice(currentInstanceIndex, 1);
            if (currentInstanceIndex >= instances.length) {
                currentInstanceIndex = instances.length - 1;
            }
            loadInstance(currentInstanceIndex);
        }
    });

    // Form submission handler
    document.getElementById('fill-form').addEventListener('submit', function(e) {
        e.preventDefault();

        // Save current instance
        saveCurrentInstance();

        // Serialize all instances to hidden input
        document.getElementById('batch-data-input').value = JSON.stringify(instances);

        // Submit form
        this.submit();
    });

    // Initialize on page load
    initializeInstances();

    // ========================================
    // Excel Import Handler
    // ========================================

    // Require SheetJS library for Excel parsing
    const sheetJsScript = document.createElement('script');
    sheetJsScript.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
    document.head.appendChild(sheetJsScript);

    document.getElementById('btn-process-excel').addEventListener('click', async function() {
        const fileInput = document.getElementById('excel-file-input');
        const statusDiv = document.getElementById('excel-upload-status');

        if (!fileInput.files || fileInput.files.length === 0) {
            statusDiv.innerHTML = '<div class="alert alert-warning">Por favor, selecione um arquivo Excel.</div>';
            return;
        }

        const file = fileInput.files[0];
        statusDiv.innerHTML = '<div class="alert alert-info">Processando arquivo...</div>';

        try {
            // Wait for XLSX library to load
            while (typeof XLSX === 'undefined') {
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet);

            if (rows.length === 0) {
                statusDiv.innerHTML = '<div class="alert alert-warning">O arquivo Excel est√° vazio.</div>';
                return;
            }

            // Clear current instances
            instances = [];

            // Convert each row to an instance
            rows.forEach(row => {
                const instance = {};
                for (const [key, value] of Object.entries(row)) {
                    // Skip special columns
                    if (key.startsWith('_')) continue;

                    // Convert values to appropriate types
                    if (value === true || value === 'TRUE' || value === 'true' || value === 1) {
                        instance[key] = true;
                    } else if (value === false || value === 'FALSE' || value === 'false' || value === 0) {
                        instance[key] = false;
                    } else if (value !== null && value !== undefined) {
                        instance[key] = String(value);
                    }
                }
                instances.push(instance);
            });

            // Load first instance
            currentInstanceIndex = 0;
            loadInstance(0);

            statusDiv.innerHTML = `<div class="alert alert-success">‚úì ${instances.length} inst√¢ncia(s) importada(s) com sucesso!</div>`;

            // Close modal after 2 seconds
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('uploadExcelModal')).hide();
                statusDiv.innerHTML = '';
                fileInput.value = '';
            }, 2000);

        } catch (error) {
            console.error('Excel import error:', error);
            statusDiv.innerHTML = `<div class="alert alert-danger">Erro ao processar arquivo: ${error.message}</div>`;
        }
    });
</script>
{% endblock %}
