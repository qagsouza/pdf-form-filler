{% extends "base.html" %}

{% block title %}{{ template.name }} - Template{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>{{ template.name }}</h1>
                <div>
                    <a href="/templates" class="btn btn-secondary">Voltar</a>
                </div>
            </div>

            <!-- Success/Error Messages -->
            {% if request.query_params.get('success') == 'updated' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> Template atualizado com sucesso!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('success') == 'shared' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> Template compartilhado com sucesso!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('success') == 'share_removed' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> Compartilhamento removido!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('success') == 'defaults_saved' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> Valores padr√£o salvos com sucesso!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('success') == 'pdf_replaced' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> <strong>PDF substitu√≠do com sucesso!</strong><br>
                O template foi atualizado para a vers√£o {{ template.version }}. Os campos foram re-extra√≠dos automaticamente.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'user_not_found' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Usu√°rio n√£o encontrado.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'share_failed' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Falha ao compartilhar template.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'invalid_file' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Arquivo inv√°lido. Apenas arquivos PDF s√£o permitidos.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'file_too_large' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Arquivo muito grande. Tamanho m√°ximo: 10MB.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'invalid_pdf' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Arquivo PDF inv√°lido ou corrompido.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'replace_failed' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Falha ao substituir PDF. Tente novamente.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            <!-- Template Info -->
            <div class="row">
                <div class="col-md-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Informa√ß√µes do Template</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Nome:</strong> {{ template.name }}
                            </div>
                            <div class="mb-3">
                                <strong>Descri√ß√£o:</strong><br>
                                {{ template.description or 'Sem descri√ß√£o' }}
                            </div>
                            <div class="mb-3">
                                <strong>Arquivo:</strong> {{ template.original_filename }}
                            </div>
                            <div class="mb-3">
                                <strong>Permiss√£o:</strong>
                                {% if permission == 'owner' %}
                                    <span class="badge bg-success">Owner</span>
                                {% elif permission == 'admin' %}
                                    <span class="badge bg-danger">Admin</span>
                                {% elif permission == 'editor' %}
                                    <span class="badge bg-warning">Editor</span>
                                {% else %}
                                    <span class="badge bg-info">Viewer</span>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <strong>Campos:</strong> {{ field_count }}
                            </div>
                            <div class="mb-3">
                                <strong>Vers√£o:</strong> {{ template.version }}
                            </div>
                            <div class="mb-3">
                                <strong>Criado em:</strong> {{ template.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </div>
                            <div class="mb-3">
                                <strong>Atualizado em:</strong> {{ template.updated_at.strftime('%d/%m/%Y %H:%M') }}
                            </div>

                            {% if is_owner or permission in ['admin', 'editor'] %}
                            <div class="mt-4">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editTemplateModal">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Quick Actions -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">A√ß√µes R√°pidas</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="/fill/{{ template.id }}" class="btn btn-primary">
                                    <i class="bi bi-file-earmark-fill"></i> Preencher Formul√°rio
                                </a>
                                {% if is_owner or permission in ['admin', 'editor'] %}
                                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#defaultValuesModal">
                                    <i class="bi bi-pencil-square"></i> Propriedades dos Campos
                                </button>
                                {% endif %}
                                <a href="/batch/{{ template.id }}" class="btn btn-info">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> Preenchimento em Lote
                                </a>
                                <a href="/templates/{{ template.id }}/download-excel" class="btn btn-outline-secondary">
                                    <i class="bi bi-file-earmark-excel"></i> Baixar Template Excel
                                </a>
                                <a href="/templates/{{ template.id }}/download" class="btn btn-secondary">
                                    <i class="bi bi-download"></i> Download PDF
                                </a>
                                {% if is_owner %}
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#shareTemplateModal">
                                    <i class="bi bi-share"></i> Compartilhar
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fields -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Campos do Formul√°rio ({{ field_count }})</h5>
                </div>
                <div class="card-body">
                    {% if fields %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nome do Campo</th>
                                    <th>Tipo</th>
                                    <th>P√°gina</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for field_name, field_info in fields.items() %}
                                <tr>
                                    <td><code>{{ field_name }}</code></td>
                                    <td>
                                        {% if field_info.type == 'text' %}
                                            <span class="badge bg-primary">Texto</span>
                                        {% elif field_info.type == 'button' %}
                                            <span class="badge bg-success">Bot√£o/Checkbox</span>
                                        {% elif field_info.type == 'choice' %}
                                            <span class="badge bg-info">Escolha</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ field_info.type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ field_info.page + 1 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        Nenhum campo detectado neste PDF.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Sharing (Only for owner/admin) -->
            {% if shares is not none %}
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Compartilhamento ({{ shares|length }})</h5>
                </div>
                <div class="card-body">
                    {% if shares %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Usu√°rio</th>
                                    <th>Email</th>
                                    <th>Permiss√£o</th>
                                    <th>Compartilhado em</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in shares %}
                                <tr>
                                    <td>{{ item.user.full_name if item.user else 'Usu√°rio desconhecido' }}</td>
                                    <td>{{ item.user.email if item.user else '-' }}</td>
                                    <td>
                                        {% if item.share.permission.value == 'admin' %}
                                            <span class="badge bg-danger">Admin</span>
                                        {% elif item.share.permission.value == 'editor' %}
                                            <span class="badge bg-warning">Editor</span>
                                        {% else %}
                                            <span class="badge bg-info">Viewer</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.share.created_at.strftime('%d/%m/%Y') }}</td>
                                    <td>
                                        <form method="POST" action="/templates/{{ template.id }}/share/{{ item.share.id }}/remove"
                                              onsubmit="return confirm('Tem certeza que deseja remover este compartilhamento?')"
                                              class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-trash"></i> Remover
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        Este template n√£o est√° compartilhado com ningu√©m.
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Template Modal -->
{% if is_owner or permission in ['admin', 'editor'] %}
<div class="modal fade" id="editTemplateModal" tabindex="-1" aria-labelledby="editTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/templates/{{ template.id }}/update" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTemplateModalLabel">Editar Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Nome do Template</label>
                        <input type="text" class="form-control" id="edit_name" name="name" value="{{ template.name }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Descri√ß√£o</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="3">{{ template.description or '' }}</textarea>
                    </div>

                    <hr class="my-4">

                    <h6 class="mb-3">
                        <i class="bi bi-arrow-repeat"></i> Substituir PDF (opcional)
                    </h6>

                    <div class="mb-3">
                        <label for="pdf_file_edit" class="form-label">Novo Arquivo PDF</label>
                        <input type="file" class="form-control" id="pdf_file_edit" name="file" accept=".pdf">
                        <div class="form-text">Deixe vazio para manter o PDF atual (m√°x. 10MB)</div>
                    </div>

                    <div id="version_options_container" style="display:none;">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> <strong>Aten√ß√£o:</strong>
                            <ul class="mb-0 mt-2">
                                <li>O arquivo PDF atual ser√° substitu√≠do pela nova vers√£o</li>
                                <li>Os campos do formul√°rio ser√£o re-extra√≠dos automaticamente</li>
                                <li>Valores padr√£o e compartilhamentos ser√£o mantidos</li>
                                <li>A vers√£o do template ser√° incrementada</li>
                            </ul>
                        </div>

                        <div class="mb-3">
                            <label for="version_type_edit" class="form-label">Tipo de Atualiza√ß√£o</label>
                            <select class="form-select" id="version_type_edit" name="version_type">
                                <option value="major" selected>
                                    üî¥ Major - Mudan√ßa significativa (ex: novos campos, estrutura alterada)
                                </option>
                                <option value="minor">
                                    üü° Minor - Corre√ß√£o ou ajuste pequeno (ex: texto corrigido, layout ajustado)
                                </option>
                            </select>
                            <div class="form-text">
                                <strong>Major:</strong> Incrementa vers√£o {{ template.version_major }}.{{ template.version_minor }} ‚Üí {{ template.version_major + 1 }}.0<br>
                                <strong>Minor:</strong> Incrementa vers√£o {{ template.version_major }}.{{ template.version_minor }} ‚Üí {{ template.version_major }}.{{ template.version_minor + 1 }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="version_notes_edit" class="form-label">Notas da Vers√£o (opcional)</label>
                            <textarea class="form-control" id="version_notes_edit" name="version_notes" rows="3"
                                      placeholder="Descreva as mudan√ßas nesta vers√£o..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Show/hide version options based on file selection
document.getElementById('pdf_file_edit').addEventListener('change', function(e) {
    const versionContainer = document.getElementById('version_options_container');
    if (e.target.files && e.target.files.length > 0) {
        versionContainer.style.display = 'block';
    } else {
        versionContainer.style.display = 'none';
    }
});
</script>
{% endif %}

<!-- Share Template Modal -->
{% if is_owner %}
<div class="modal fade" id="shareTemplateModal" tabindex="-1" aria-labelledby="shareTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/templates/{{ template.id }}/share">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareTemplateModalLabel">Compartilhar Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="user_email" class="form-label">Email do Usu√°rio</label>
                        <input type="email" class="form-control" id="user_email" name="user_email" required>
                        <div class="form-text">Digite o email do usu√°rio com quem deseja compartilhar</div>
                    </div>

                    <div class="mb-3">
                        <label for="permission" class="form-label">N√≠vel de Permiss√£o</label>
                        <select class="form-select" id="permission" name="permission" required>
                            <option value="viewer" selected>Viewer - Pode visualizar e usar</option>
                            <option value="editor">Editor - Pode visualizar, usar e editar</option>
                            <option value="admin">Admin - Pode visualizar, usar, editar e gerenciar compartilhamentos</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Compartilhar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Default Values Modal -->
{% if is_owner or permission in ['admin', 'editor'] %}
<div class="modal fade" id="defaultValuesModal" tabindex="-1" aria-labelledby="defaultValuesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="/templates/{{ template.id }}/default-values">
                <div class="modal-header">
                    <h5 class="modal-title" id="defaultValuesModalLabel">
                        <i class="bi bi-pencil-square"></i> Configurar Propriedades dos Campos
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        <i class="bi bi-info-circle"></i> Defina valores padr√£o para os campos do formul√°rio.
                        Estes valores ser√£o automaticamente preenchidos ao iniciar um novo preenchimento.
                        <br><strong>Valores din√¢micos:</strong> S√£o calculados automaticamente (ex: data atual, nome do usu√°rio).
                        <br><strong>Campos travados:</strong> N√£o podem ser editados pelos usu√°rios ao preencher o formul√°rio.
                    </p>

                    {% if fields %}
                    <div style="max-height: 500px; overflow-y: auto;">
                        {% for field_name, field_info in fields.items() %}
                        <div class="mb-4 border-bottom pb-3">
                            <label class="form-label">
                                <strong>{{ field_info.label if field_info.label else field_name }}</strong>
                                {% if field_info.label %}
                                <span class="badge bg-info ms-1" style="font-size: 0.65em;">{{ field_name }}</span>
                                {% endif %}
                                <span class="badge bg-secondary ms-2" style="font-size: 0.7em;">
                                    P√°g. {{ field_info.page + 1 }}
                                </span>
                            </label>

                            <!-- Field Type Selector -->
                            <div class="mb-2">
                                <label class="form-label small">Tipo de campo:</label>
                                <select class="form-select form-select-sm field-type-selector"
                                        data-field-index="{{ loop.index }}"
                                        name="field_type_{{ field_name }}">
                                    <option value="text"
                                            {% if not template.field_config or not template.field_config.get(field_name) or not template.field_config.get(field_name).get('field_type') or template.field_config.get(field_name).get('field_type') == 'text' %}selected{% endif %}>
                                        üìù Texto
                                    </option>
                                    <option value="number"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('field_type') == 'number' %}selected{% endif %}>
                                        üî¢ N√∫mero
                                    </option>
                                    <option value="date"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('field_type') == 'date' %}selected{% endif %}>
                                        üìÖ Data
                                    </option>
                                    <option value="email"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('field_type') == 'email' %}selected{% endif %}>
                                        ‚úâÔ∏è Email
                                    </option>
                                    <option value="tel"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('field_type') == 'tel' %}selected{% endif %}>
                                        üìû Telefone
                                    </option>
                                    <option value="url"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('field_type') == 'url' %}selected{% endif %}>
                                        üîó URL
                                    </option>
                                    <option value="cpf"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('field_type') == 'cpf' %}selected{% endif %}>
                                        üÜî CPF
                                    </option>
                                </select>
                                <small class="form-text text-muted">Define o tipo de input e valida√ß√£o no formul√°rio de preenchimento</small>
                            </div>

                            <!-- Value Type Selector -->
                            <div class="mb-2">
                                <label class="form-label small">Tipo de valor:</label>
                                <select class="form-select form-select-sm value-type-selector"
                                        data-field-index="{{ loop.index }}"
                                        name="value_type_{{ field_name }}">
                                    <option value="static"
                                            {% if not template.field_config or not template.field_config.get(field_name) or not template.field_config.get(field_name).get('dynamic_type') %}selected{% endif %}>
                                        Valor est√°tico
                                    </option>
                                    <option value="dynamic"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('dynamic_type') %}selected{% endif %}>
                                        Valor din√¢mico
                                    </option>
                                </select>
                            </div>

                            <!-- Static Value Input -->
                            <div class="static-value-container-{{ loop.index }}"
                                 style="{% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('dynamic_type') %}display:none;{% endif %}">
                                {% if field_info.type == 'button' %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               id="default_{{ loop.index }}"
                                               name="default_{{ field_name }}"
                                               value="on"
                                               {% if template.default_values and template.default_values.get(field_name) %}checked{% endif %}>
                                        <label class="form-check-label" for="default_{{ loop.index }}">
                                            Marcar por padr√£o
                                        </label>
                                    </div>
                                {% elif field_info.type == 'choice' and field_info.options %}
                                    <select class="form-select" id="default_{{ loop.index }}" name="default_{{ field_name }}">
                                        <option value="">-- Sem valor padr√£o --</option>
                                        {% for option in field_info.options %}
                                        <option value="{{ option }}"
                                                {% if template.default_values and template.default_values.get(field_name) == option %}selected{% endif %}>
                                            {{ option }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                {% else %}
                                    <input type="text" class="form-control"
                                           id="default_{{ loop.index }}"
                                           name="default_{{ field_name }}"
                                           value="{{ template.default_values.get(field_name, '') if template.default_values else '' }}"
                                           placeholder="Deixe vazio para nenhum valor padr√£o">
                                {% endif %}
                            </div>

                            <!-- Dynamic Value Selector -->
                            <div class="dynamic-value-container-{{ loop.index }}"
                                 style="{% if not template.field_config or not template.field_config.get(field_name) or not template.field_config.get(field_name).get('dynamic_type') %}display:none;{% endif %}">
                                <select class="form-select dynamic-type-selector" data-field-index="{{ loop.index }}" name="dynamic_type_{{ field_name }}">
                                    <option value="">-- Selecione um tipo --</option>
                                    <option value="current_date" data-compatible-with="date,text"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('dynamic_type') == 'current_date' %}selected{% endif %}>
                                        üìÖ Data atual (YYYY-MM-DD)
                                    </option>
                                    <option value="current_date_br" data-compatible-with="date,text"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('dynamic_type') == 'current_date_br' %}selected{% endif %}>
                                        üìÖ Data atual (DD/MM/YYYY)
                                    </option>
                                    <option value="current_datetime" data-compatible-with="text"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('dynamic_type') == 'current_datetime' %}selected{% endif %}>
                                        üïê Data e hora atual
                                    </option>
                                    <option value="current_time" data-compatible-with="text"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('dynamic_type') == 'current_time' %}selected{% endif %}>
                                        üïê Hora atual
                                    </option>
                                    <option value="current_year" data-compatible-with="number,text"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('dynamic_type') == 'current_year' %}selected{% endif %}>
                                        üìÖ Ano atual
                                    </option>
                                    <option value="user_name" data-compatible-with="text"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('dynamic_type') == 'user_name' %}selected{% endif %}>
                                        üë§ Nome do usu√°rio
                                    </option>
                                    <option value="user_email" data-compatible-with="email,text"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('dynamic_type') == 'user_email' %}selected{% endif %}>
                                        ‚úâÔ∏è Email do usu√°rio
                                    </option>
                                    <option value="user_username" data-compatible-with="text"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('dynamic_type') == 'user_username' %}selected{% endif %}>
                                        üë§ Username do usu√°rio
                                    </option>
                                    <option value="serial_number" data-compatible-with="number,text"
                                            {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('dynamic_type') == 'serial_number' %}selected{% endif %}>
                                        üî¢ N√∫mero de s√©rie sequencial
                                    </option>
                                </select>
                            </div>

                            <!-- Lock Field Checkbox -->
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox"
                                       id="locked_{{ loop.index }}"
                                       name="locked_{{ field_name }}"
                                       value="true"
                                       {% if template.field_config and template.field_config.get(field_name) and template.field_config.get(field_name).get('locked') %}checked{% endif %}>
                                <label class="form-check-label small text-muted" for="locked_{{ loop.index }}">
                                    üîí Travar campo (n√£o edit√°vel no preenchimento)
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        Este template n√£o possui campos configurados.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Propriedades</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}

{% block extra_scripts %}
<script>
// Handle value type selector change
document.addEventListener('DOMContentLoaded', function() {
    const valueTypeSelectors = document.querySelectorAll('.value-type-selector');

    valueTypeSelectors.forEach(function(selector) {
        selector.addEventListener('change', function() {
            const fieldIndex = this.dataset.fieldIndex;
            const staticContainer = document.querySelector(`.static-value-container-${fieldIndex}`);
            const dynamicContainer = document.querySelector(`.dynamic-value-container-${fieldIndex}`);

            if (this.value === 'static') {
                staticContainer.style.display = 'block';
                dynamicContainer.style.display = 'none';
            } else {
                staticContainer.style.display = 'none';
                dynamicContainer.style.display = 'block';
            }
        });
    });

    // Handle field type selector change - filter dynamic type options
    const fieldTypeSelectors = document.querySelectorAll('.field-type-selector');

    // Function to filter dynamic type options based on field type
    function filterDynamicOptions(fieldIndex, fieldType) {
        const dynamicSelect = document.querySelector(`.dynamic-type-selector[data-field-index="${fieldIndex}"]`);
        if (!dynamicSelect) return;

        const currentValue = dynamicSelect.value;
        const options = dynamicSelect.querySelectorAll('option[data-compatible-with]');

        options.forEach(function(option) {
            const compatibleTypes = option.dataset.compatibleWith.split(',');
            if (compatibleTypes.includes(fieldType)) {
                option.style.display = '';
                option.disabled = false;
            } else {
                option.style.display = 'none';
                option.disabled = true;
            }
        });

        // If current selected value is not compatible, reset to empty
        const currentOption = dynamicSelect.querySelector(`option[value="${currentValue}"]`);
        if (currentOption && currentOption.disabled) {
            dynamicSelect.value = '';
        }
    }

    fieldTypeSelectors.forEach(function(selector) {
        const fieldIndex = selector.dataset.fieldIndex;

        // Filter on page load
        filterDynamicOptions(fieldIndex, selector.value);

        // Filter when field type changes
        selector.addEventListener('change', function() {
            filterDynamicOptions(fieldIndex, this.value);
        });
    });
});
</script>
{% endblock %}
