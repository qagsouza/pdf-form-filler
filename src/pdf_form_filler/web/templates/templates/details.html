{% extends "base.html" %}

{% block title %}{{ template.name }} - Template{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>{{ template.name }}</h1>
                <div>
                    <a href="/templates" class="btn btn-secondary">Voltar</a>
                </div>
            </div>

            <!-- Success/Error Messages -->
            {% if request.query_params.get('success') == 'updated' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> Template atualizado com sucesso!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('success') == 'shared' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> Template compartilhado com sucesso!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('success') == 'share_removed' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> Compartilhamento removido!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('success') == 'defaults_saved' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> Valores padr√£o salvos com sucesso!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('success') == 'field_configured' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> Configura√ß√£o do campo salva com sucesso!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('success') == 'pdf_replaced' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> <strong>PDF substitu√≠do com sucesso!</strong><br>
                O template foi atualizado para a vers√£o {{ template.version }}. Os campos foram re-extra√≠dos automaticamente.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'user_not_found' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Usu√°rio n√£o encontrado.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'share_failed' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Falha ao compartilhar template.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'invalid_file' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Arquivo inv√°lido. Apenas arquivos PDF s√£o permitidos.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'file_too_large' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Arquivo muito grande. Tamanho m√°ximo: 10MB.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'invalid_pdf' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Arquivo PDF inv√°lido ou corrompido.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'replace_failed' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Falha ao substituir PDF. Tente novamente.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('success') == 'ownership_transferred' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> Propriedade do template transferida com sucesso!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'user_not_found' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Usu√°rio n√£o encontrado. Verifique o username e tente novamente.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'already_owner' %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="bi bi-info-circle"></i> Este usu√°rio j√° √© o propriet√°rio do template.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% if request.query_params.get('error') == 'transfer_failed' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> Falha ao transferir propriedade. Tente novamente.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            <!-- Template Info -->
            <div class="row">
                <div class="col-md-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Informa√ß√µes do Template</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Nome:</strong> {{ template.name }}
                            </div>
                            <div class="mb-3">
                                <strong>Descri√ß√£o:</strong><br>
                                {{ template.description or 'Sem descri√ß√£o' }}
                            </div>
                            <div class="mb-3">
                                <strong>Arquivo:</strong> {{ template.original_filename }}
                            </div>
                            <div class="mb-3">
                                <strong>Permiss√£o:</strong>
                                {% if permission == 'owner' %}
                                    <span class="badge bg-success">Owner</span>
                                {% elif permission == 'admin' %}
                                    <span class="badge bg-danger">Admin</span>
                                {% elif permission == 'editor' %}
                                    <span class="badge bg-warning">Editor</span>
                                {% else %}
                                    <span class="badge bg-info">Viewer</span>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <strong>Campos:</strong> {{ field_count }}
                            </div>
                            <div class="mb-3">
                                <strong>Vers√£o:</strong> {{ template.version }}
                            </div>
                            <div class="mb-3">
                                <strong>Criado em:</strong> {{ template.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </div>
                            <div class="mb-3">
                                <strong>Atualizado em:</strong> {{ template.updated_at.strftime('%d/%m/%Y %H:%M') }}
                            </div>

                            {% if is_owner or permission in ['admin', 'editor'] %}
                            <div class="mt-4">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editTemplateModal">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                {% if is_owner %}
                                <button type="button" class="btn btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#deleteTemplateModal">
                                    <i class="bi bi-trash"></i> Excluir
                                </button>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Quick Actions -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">A√ß√µes R√°pidas</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="/fill/{{ template.id }}" class="btn btn-primary">
                                    <i class="bi bi-file-earmark-fill"></i> Preencher Formul√°rio HTML
                                </a>
                                <a href="/templates/{{ template.id }}/fill-inline" class="btn btn-success">
                                    <i class="bi bi-file-earmark-pdf"></i> Preencher no Navegador
                                </a>
                                <a href="/batch/{{ template.id }}" class="btn btn-info">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> Preenchimento em Lote
                                </a>
                                <a href="/templates/{{ template.id }}/download-excel" class="btn btn-outline-secondary">
                                    <i class="bi bi-file-earmark-excel"></i> Baixar Template Excel
                                </a>
                                <a href="/templates/{{ template.id }}/download" class="btn btn-secondary">
                                    <i class="bi bi-download"></i> Download PDF
                                </a>
                                {% if is_owner %}
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#shareTemplateModal">
                                    <i class="bi bi-share"></i> Compartilhar
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sharing (Only for owner/admin) -->
            {% if shares is not none %}
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Compartilhamento ({{ shares|length }})</h5>
                    {% if permission in ['owner', 'admin'] %}
                    <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#transferOwnershipModal">
                        <i class="bi bi-arrow-left-right"></i> Transferir Propriedade
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if shares %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Nome</th>
                                    <th>Detalhes</th>
                                    <th>Permiss√£o</th>
                                    <th>Compartilhado em</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in shares %}
                                <tr>
                                    <td>
                                        {% if item.type == 'user' %}
                                            <i class="bi bi-person-fill text-primary"></i> Usu√°rio
                                        {% else %}
                                            <i class="bi bi-people-fill text-success"></i> Grupo
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.type == 'user' %}
                                            {{ item.user.full_name if item.user else 'Usu√°rio desconhecido' }}
                                        {% else %}
                                            {{ item.group.name if item.group else 'Grupo desconhecido' }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.type == 'user' %}
                                            {{ item.user.email if item.user else '-' }}
                                        {% else %}
                                            {{ item.group.members|length }} membros
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.share.permission.value == 'admin' %}
                                            <span class="badge bg-danger">Admin</span>
                                        {% elif item.share.permission.value == 'editor' %}
                                            <span class="badge bg-warning">Editor</span>
                                        {% else %}
                                            <span class="badge bg-info">Viewer</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.share.created_at.strftime('%d/%m/%Y') }}</td>
                                    <td>
                                        <form method="POST" action="/templates/{{ template.id }}/share/{{ item.share.id }}/remove"
                                              onsubmit="return confirm('Tem certeza que deseja remover este compartilhamento?')"
                                              class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-trash"></i> Remover
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        Este template n√£o est√° compartilhado com ningu√©m.
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Fields -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Campos do Formul√°rio ({{ field_count }})</h5>
                </div>
                <div class="card-body">
                    {% if fields %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Descri√ß√£o</th>
                                    <th>Nome do Campo</th>
                                    <th>Tipo</th>
                                    <th>P√°gina</th>
                                    {% if is_owner or permission in ['admin', 'editor'] %}
                                    <th>A√ß√µes</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for field_name, field_info in fields.items() %}
                                <tr>
                                    <td>{{ field_info.label if field_info.label else '-' }}</td>
                                    <td><code>{{ field_name }}</code></td>
                                    <td>
                                        {% if field_info.type == 'text' %}
                                            <span class="badge bg-primary">Texto</span>
                                        {% elif field_info.type == 'button' %}
                                            <span class="badge bg-success">Bot√£o/Checkbox</span>
                                        {% elif field_info.type == 'choice' %}
                                            <span class="badge bg-info">Escolha</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ field_info.type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ field_info.page + 1 }}</td>
                                    {% if is_owner or permission in ['admin', 'editor'] %}
                                    <td>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary"
                                                onclick="openFieldConfigModal('{{ field_name }}')">
                                            <i class="bi bi-gear"></i> Configurar
                                        </button>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        Nenhum campo detectado neste PDF.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Template Modal -->
{% if is_owner or permission in ['admin', 'editor'] %}
<div class="modal fade" id="editTemplateModal" tabindex="-1" aria-labelledby="editTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/templates/{{ template.id }}/update" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTemplateModalLabel">Editar Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Nome do Template</label>
                        <input type="text" class="form-control" id="edit_name" name="name" value="{{ template.name }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Descri√ß√£o</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="3">{{ template.description or '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="edit_group_id" class="form-label">Grupo (opcional)</label>
                        <select class="form-select" id="edit_group_id" name="group_id">
                            <option value="">Nenhum grupo</option>
                            {% for group in all_groups %}
                            <option value="{{ group.id }}" {% if template.group_id == group.id %}selected{% endif %}>
                                {{ group.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Associe este template a um grupo para melhor organiza√ß√£o</div>
                    </div>

                    <hr class="my-4">

                    <h6 class="mb-3">
                        <i class="bi bi-arrow-repeat"></i> Substituir PDF (opcional)
                    </h6>

                    <div class="mb-3">
                        <label for="pdf_file_edit" class="form-label">Novo Arquivo PDF</label>
                        <input type="file" class="form-control" id="pdf_file_edit" name="file" accept=".pdf">
                        <div class="form-text">Deixe vazio para manter o PDF atual (m√°x. 10MB)</div>
                    </div>

                    <div id="version_options_container" style="display:none;">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> <strong>Aten√ß√£o:</strong>
                            <ul class="mb-0 mt-2">
                                <li>O arquivo PDF atual ser√° substitu√≠do pela nova vers√£o</li>
                                <li>Os campos do formul√°rio ser√£o re-extra√≠dos automaticamente</li>
                                <li>Valores padr√£o e compartilhamentos ser√£o mantidos</li>
                                <li>A vers√£o do template ser√° incrementada</li>
                            </ul>
                        </div>

                        <div class="mb-3">
                            <label for="version_type_edit" class="form-label">Tipo de Atualiza√ß√£o</label>
                            <select class="form-select" id="version_type_edit" name="version_type">
                                <option value="major" selected>
                                    üî¥ Major - Mudan√ßa significativa (ex: novos campos, estrutura alterada)
                                </option>
                                <option value="minor">
                                    üü° Minor - Corre√ß√£o ou ajuste pequeno (ex: texto corrigido, layout ajustado)
                                </option>
                            </select>
                            <div class="form-text">
                                <strong>Major:</strong> Incrementa vers√£o {{ template.version_major }}.{{ template.version_minor }} ‚Üí {{ template.version_major + 1 }}.0<br>
                                <strong>Minor:</strong> Incrementa vers√£o {{ template.version_major }}.{{ template.version_minor }} ‚Üí {{ template.version_major }}.{{ template.version_minor + 1 }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="version_notes_edit" class="form-label">Notas da Vers√£o (opcional)</label>
                            <textarea class="form-control" id="version_notes_edit" name="version_notes" rows="3"
                                      placeholder="Descreva as mudan√ßas nesta vers√£o..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Show/hide version options based on file selection
document.getElementById('pdf_file_edit').addEventListener('change', function(e) {
    const versionContainer = document.getElementById('version_options_container');
    if (e.target.files && e.target.files.length > 0) {
        versionContainer.style.display = 'block';
    } else {
        versionContainer.style.display = 'none';
    }
});
</script>
{% endif %}

<!-- Share Template Modal -->
{% if is_owner %}
<div class="modal fade" id="shareTemplateModal" tabindex="-1" aria-labelledby="shareTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/templates/{{ template.id }}/share">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareTemplateModalLabel">Compartilhar Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Compartilhar com:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="share_type" id="share_user" value="user" checked autocomplete="off">
                            <label class="btn btn-outline-primary" for="share_user">
                                <i class="bi bi-person"></i> Usu√°rio
                            </label>

                            <input type="radio" class="btn-check" name="share_type" id="share_group" value="group" autocomplete="off">
                            <label class="btn btn-outline-primary" for="share_group">
                                <i class="bi bi-people-fill"></i> Grupo
                            </label>
                        </div>
                    </div>

                    <div id="user_share_section">
                        <div class="mb-3">
                            <label for="user_email" class="form-label">Email do Usu√°rio</label>
                            <input type="email" class="form-control" id="user_email" name="user_email">
                            <div class="form-text">Digite o email do usu√°rio com quem deseja compartilhar</div>
                        </div>
                    </div>

                    <div id="group_share_section" style="display: none;">
                        <div class="mb-3">
                            <label for="group_id" class="form-label">Selecione o Grupo</label>
                            <select class="form-select" id="group_id" name="group_id">
                                <option value="">Selecione um grupo...</option>
                                {% for group in all_groups %}
                                <option value="{{ group.id }}">{{ group.name }} ({{ group.members|length }} membros)</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Escolha o grupo com quem deseja compartilhar</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="permission" class="form-label">N√≠vel de Permiss√£o</label>
                        <select class="form-select" id="permission" name="permission" required>
                            <option value="viewer" selected>Viewer - Pode visualizar e usar</option>
                            <option value="editor">Editor - Pode visualizar, usar e editar</option>
                            <option value="admin">Admin - Pode visualizar, usar, editar e gerenciar compartilhamentos</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Compartilhar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Toggle between user and group share sections
document.querySelectorAll('input[name="share_type"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        const userSection = document.getElementById('user_share_section');
        const groupSection = document.getElementById('group_share_section');
        const userEmailInput = document.getElementById('user_email');
        const groupIdInput = document.getElementById('group_id');

        if (this.value === 'user') {
            userSection.style.display = 'block';
            groupSection.style.display = 'none';
            userEmailInput.required = true;
            groupIdInput.required = false;
        } else {
            userSection.style.display = 'none';
            groupSection.style.display = 'block';
            userEmailInput.required = false;
            groupIdInput.required = true;
        }
    });
});
</script>
{% endif %}


<!-- Delete Template Modal -->
{% if is_owner %}
<div class="modal fade" id="deleteTemplateModal" tabindex="-1" aria-labelledby="deleteTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTemplateModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Confirmar Exclus√£o
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita!
                </div>
                <p>Tem certeza que deseja excluir o template <strong>{{ template.name }}</strong>?</p>
                <p>Ao excluir este template:</p>
                <ul>
                    <li>O arquivo PDF ser√° removido permanentemente</li>
                    <li>Todos os compartilhamentos ser√£o removidos</li>
                    <li>As configura√ß√µes de campos ser√£o perdidas</li>
                    <li>Os usu√°rios com acesso compartilhado perder√£o o acesso</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="/templates/{{ template.id }}/delete" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Sim, Excluir Template
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Single Field Configuration Modal -->
{% if is_owner or permission in ['admin', 'editor'] %}
<div class="modal fade" id="singleFieldConfigModal" tabindex="-1" aria-labelledby="fieldConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/templates/{{ template.id }}/configure-field">
                <div class="modal-header">
                    <h5 class="modal-title" id="fieldConfigModalLabel">
                        <i class="bi bi-gear"></i> Configurar Campo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="config_field_name" name="field_name">

                    <div class="mb-3">
                        <label for="config_field_type" class="form-label">Tipo de campo:</label>
                        <select class="form-select" id="config_field_type" name="field_type">
                            <option value="text">üìù Texto</option>
                            <option value="number">üî¢ N√∫mero</option>
                            <option value="date">üìÖ Data</option>
                            <option value="email">üìß Email</option>
                            <option value="tel">üìû Telefone</option>
                            <option value="url">üîó URL</option>
                            <option value="cpf">üÜî CPF</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="config_is_dynamic" name="is_dynamic">
                            <label class="form-check-label" for="config_is_dynamic">
                                Usar valor din√¢mico
                            </label>
                        </div>
                    </div>

                    <div class="mb-3" id="config_default_value_div">
                        <label for="config_default_value" class="form-label">Valor padr√£o:</label>
                        <input type="text" class="form-control" id="config_default_value" name="default_value">
                    </div>

                    <div class="mb-3" id="config_dynamic_type_div" style="display:none;">
                        <label for="config_dynamic_type" class="form-label">Tipo de valor din√¢mico:</label>
                        <select class="form-select" id="config_dynamic_type" name="dynamic_type">
                            <option value="current_date">üìÖ Data atual (YYYY-MM-DD)</option>
                            <option value="current_date_br">üìÖ Data atual (DD/MM/YYYY)</option>
                            <option value="current_datetime">üïê Data e hora atual</option>
                            <option value="current_time">‚è∞ Hora atual</option>
                            <option value="current_year">üìÜ Ano atual</option>
                            <option value="user_name">üë§ Nome do usu√°rio</option>
                            <option value="user_email">üìß Email do usu√°rio</option>
                            <option value="user_username">üîë Username do usu√°rio</option>
                            <option value="serial_number">üî¢ N√∫mero sequencial</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Transfer Ownership Modal -->
<div class="modal fade" id="transferOwnershipModal" tabindex="-1" aria-labelledby="transferOwnershipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/templates/{{ template.id }}/transfer-ownership" onsubmit="return confirm('Tem certeza que deseja transferir a propriedade deste template? Voc√™ se tornar√° um admin compartilhado.')">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="transferOwnershipModalLabel">
                        <i class="bi bi-arrow-left-right"></i> Transferir Propriedade
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Aten√ß√£o:</strong> Ao transferir a propriedade, voc√™ deixar√° de ser o dono do template.
                        Voc√™ receber√° permiss√£o de <strong>admin</strong> para continuar gerenciando o template.
                    </div>

                    <div class="mb-3">
                        <label for="new_owner_username" class="form-label">Username do Novo Propriet√°rio</label>
                        <input type="text"
                               class="form-control"
                               id="new_owner_username"
                               name="new_owner_username"
                               list="usernames_list"
                               autocomplete="off"
                               required>
                        <datalist id="usernames_list">
                            <!-- Will be populated dynamically -->
                        </datalist>
                        <div class="form-text">Digite ou selecione o username do usu√°rio que se tornar√° o novo propriet√°rio</div>
                    </div>

                    <div class="alert alert-info">
                        <strong>O que acontecer√°:</strong>
                        <ul class="mb-0 mt-2">
                            <li>O novo propriet√°rio ter√° controle total sobre o template</li>
                            <li>Voc√™ receber√° permiss√£o de admin (pode gerenciar compartilhamentos)</li>
                            <li>Todos os compartilhamentos existentes ser√£o mantidos</li>
                            <li>Esta a√ß√£o pode ser revertida pelo novo propriet√°rio</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-left-right"></i> Transferir Propriedade
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Autocomplete for username in transfer ownership modal
    const usernameInput = document.getElementById('new_owner_username');
    const datalist = document.getElementById('usernames_list');
    let debounceTimer;

    if (usernameInput) {
        usernameInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const query = this.value;

            if (query.length < 2) {
                datalist.innerHTML = '';
                return;
            }

            debounceTimer = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    datalist.innerHTML = '';
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = `${user.username} - ${user.full_name}`;
                        datalist.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error fetching users:', error);
                }
            }, 300); // Wait 300ms after user stops typing
        });
    }

    // Field configuration modal
    window.openFieldConfigModal = function(fieldName) {
        console.log('Opening modal for field:', fieldName);

        const modalElement = document.getElementById('singleFieldConfigModal');
        if (!modalElement) {
            console.error('Modal element not found!');
            return;
        }

        const modal = new bootstrap.Modal(modalElement);

        // Update modal title
        const titleElement = document.getElementById('fieldConfigModalLabel');
        if (titleElement) {
            titleElement.innerHTML = `<i class="bi bi-gear"></i> Configurar Campo: <code>${fieldName}</code>`;
        }

        // Set field name in hidden input
        const fieldNameInput = document.getElementById('config_field_name');
        if (fieldNameInput) {
            fieldNameInput.value = fieldName;
        }

        // Get current config
        const fieldConfig = {{ template.field_config|tojson|safe }} || {};
        const config = fieldConfig[fieldName] || {};

        // Set field type
        const fieldTypeSelect = document.getElementById('config_field_type');
        if (fieldTypeSelect) {
            fieldTypeSelect.value = config.field_type || 'text';
        }

        // Set default value
        const defaultValues = {{ template.default_values|tojson|safe }} || {};
        const defaultValueInput = document.getElementById('config_default_value');
        if (defaultValueInput) {
            defaultValueInput.value = defaultValues[fieldName] || '';
        }

        // Set dynamic type
        const dynamicTypeSelect = document.getElementById('config_dynamic_type');
        const isDynamicCheckbox = document.getElementById('config_is_dynamic');
        const defaultValueDiv = document.getElementById('config_default_value_div');
        const dynamicTypeDiv = document.getElementById('config_dynamic_type_div');

        if (config.dynamic_type) {
            if (isDynamicCheckbox) isDynamicCheckbox.checked = true;
            if (dynamicTypeSelect) dynamicTypeSelect.value = config.dynamic_type;
            if (defaultValueDiv) defaultValueDiv.style.display = 'none';
            if (dynamicTypeDiv) dynamicTypeDiv.style.display = 'block';
        } else {
            if (isDynamicCheckbox) isDynamicCheckbox.checked = false;
            if (defaultValueDiv) defaultValueDiv.style.display = 'block';
            if (dynamicTypeDiv) dynamicTypeDiv.style.display = 'none';
        }

        console.log('Showing modal...');
        modal.show();
    };

    // Toggle between default value and dynamic type
    document.getElementById('config_is_dynamic')?.addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('config_default_value_div').style.display = 'none';
            document.getElementById('config_dynamic_type_div').style.display = 'block';
        } else {
            document.getElementById('config_default_value_div').style.display = 'block';
            document.getElementById('config_dynamic_type_div').style.display = 'none';
        }
    });
});
</script>
{% endblock %}
