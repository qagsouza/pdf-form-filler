<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PDF Form Filler</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h1>PDF Form Filler</h1>
    <p class="text-muted">Envie um PDF que contenha campos AcroForm (text, checkbox, radio).</p>

    <div class="card p-4 mb-3">
      <form id="upload-form" method="post" action="/upload" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="pdf-input" class="form-label">Selecione o arquivo PDF</label>
          <input id="pdf-input" class="form-control" type="file" name="pdf" accept="application/pdf,.pdf" required>
        </div>
        <button class="btn btn-primary" type="button" id="upload-btn">
          <span id="btn-text">Enviar PDF</span>
          <span id="spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
        </button>
      </form>
    </div>

    <div id="form-area"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Upload via JavaScript Fetch API
    document.getElementById('upload-btn').addEventListener('click', async function() {
      const form = document.getElementById('upload-form');
      const fileInput = document.getElementById('pdf-input');
      const btnText = document.getElementById('btn-text');
      const spinner = document.getElementById('spinner');
      const formArea = document.getElementById('form-area');

      // Validate
      if (!fileInput.files || !fileInput.files[0]) {
        alert('Por favor, selecione um arquivo PDF');
        return;
      }

      // Show spinner
      btnText.textContent = 'Enviando...';
      spinner.classList.remove('d-none');
      this.disabled = true;

      try {
        // Create FormData
        const formData = new FormData(form);

        // Upload
        const response = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || 'Erro ao processar PDF');
        }

        // Get HTML response
        const html = await response.text();

        // Update form area
        formArea.innerHTML = html;

        // Scroll to result
        formArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      } catch (error) {
        console.error('Upload error:', error);
        formArea.innerHTML = `
          <div class="alert alert-danger alert-dismissible fade show">
            <strong>Erro!</strong> ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;
      } finally {
        // Reset button
        btnText.textContent = 'Enviar PDF';
        spinner.classList.add('d-none');
        this.disabled = false;
      }
    });

    // Event delegation for fill form button (works with dynamically inserted content)
    document.body.addEventListener('click', async function(e) {
      // Check if the clicked element is the fill button
      if (e.target.id === 'fill-btn' || e.target.closest('#fill-btn')) {
        e.preventDefault();

        const fillBtn = document.getElementById('fill-btn');
        const form = document.getElementById('fill-form');
        const btnText = document.getElementById('fill-btn-text');
        const spinner = document.getElementById('fill-spinner');
        const formArea = document.getElementById('form-area');

        if (!form) {
          console.error('Form not found');
          return;
        }

        console.log('Fill button clicked');

        // Show spinner
        btnText.textContent = 'Gerando PDF...';
        spinner.classList.remove('d-none');
        fillBtn.disabled = true;

        try {
          // Create FormData
          const formData = new FormData(form);
          console.log('Sending to /fill...');

          // Submit
          const response = await fetch('/fill', {
            method: 'POST',
            body: formData
          });

          console.log('Response:', response.status);

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'Erro ao gerar PDF');
          }

          // Get HTML response
          const html = await response.text();
          console.log('HTML received, length:', html.length);

          // Update form area
          formArea.innerHTML = html;

          // Scroll to result
          formArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        } catch (error) {
          console.error('Fill error:', error);
          formArea.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show">
              <strong>Erro!</strong> ${error.message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
        } finally {
          // Reset button
          btnText.textContent = 'Gerar PDF Preenchido';
          spinner.classList.add('d-none');
          fillBtn.disabled = false;
        }
      }
    });
  </script>
</body>
</html>
